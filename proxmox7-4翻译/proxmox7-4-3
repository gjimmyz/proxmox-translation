proxmox7-4-3

第3章
主机系统管理

以下部分将关注常见的虚拟化任务，并解释有关 Proxmox VE 主机机器的管理和管理的 Proxmox VE 特定信息。
Proxmox VE 基于 Debian GNU/Linux，并附带额外的存储库以提供与 Proxmox VE 相关的软件包。
这意味着可以使用所有范围的 Debian 软件包，包括安全更新和错误修复。Proxmox VE 
提供了基于 Ubuntu 内核的自己的 Linux 内核。它启用了所有必要的虚拟化和容器功能，并包括 ZFS 和一些额外的硬件驱动程序。
对于以下部分未包括的其他主题，请参阅 Debian 文档。Debian 管理员手册可以在线获取，提供了对 Debian 操作系统的全面介绍（参见 [Hertzog13]）。

3.1 软件包仓库
Proxmox VE 像其他基于 Debian 的系统一样，使用 APT 作为其软件包管理工具。

3.1.1 Proxmox VE 中的存储库
存储库是软件包的集合，可以用于安装新软件，但也可以用于获取新的更新。
注意
您需要有效的 Debian 和 Proxmox 存储库才能获取最新的安全更新、错误修复和新功能。
APT 存储库在文件 /etc/apt/sources.list 中定义，并在 /etc/apt/sources 中的 .list 文件中放置。
存储库管理
自 Proxmox VE 7.0 起，您可以在 Web 界面中检查存储库状态。节点摘要面板显示高级状态概述，而单独的存储库面板显示深入状态和所有配置存储库的列表。基本存储库管理，例如激活或停用存储库，也得到了支持。
sources.list
在 sources.list 文件中，每行定义一个软件包存储库。首选源必须位于第一位。空行将被忽略。
行中任何地方的 # 字符将该行剩余部分标记为注释。通过运行 apt-get update 从存储库获取可用软件包。可以直接使用 apt-get 或通过 GUI（节点! 更新）安装更新。
文件 /etc/apt/sources.list
deb http://ftp.debian.org/debian bullseye main contrib
deb http://ftp.debian.org/debian bullseye-updates main contrib
security updates
deb http://security.debian.org/debian-security bullseye-security main -
contrib
Proxmox VE 提供了三个不同的软件包存储库。

3.1.2 Proxmox VE 企业存储库
这是默认的、稳定的和推荐的存储库，适用于所有 Proxmox VE 订阅用户。它包含了最稳定的软件包，适合生产环境使用。pve-enterprise 存储库默认启用：
文件 /etc/apt/sources.list.d/pve-enterprise.list
deb https://enterprise.proxmox.com/debian/pve bullseye pve-enterprise
root@pam 用户会通过电子邮件收到关于可用更新的通知。在 GUI 中点击 Changelog 按钮以查看有关所选更新的更多详细信息。
您需要一个有效的订阅密钥才能访问 pve-enterprise 存储库。有不同的支持级别可供选择。更多详细信息请访问 https://www.proxmox.com/en/proxmox-ve/pricing。
注意
您可以通过使用 #（位于行的开头）注释掉上面的行来禁用此存储库。如果您没有订阅密钥，这可以防止错误消息。在这种情况下，请配置 pve-no-subscription 存储库。

3.1.3 Proxmox VE 无订阅存储库
这是用于测试和非生产环境使用的推荐存储库。其软件包没有经过严格测试和验证。您无需订阅密钥即可访问 pve-no-subscription 存储库。我们建议在 /etc/apt/sources.list 中配置此存储库。
文件 /etc/apt/sources.list
deb http://ftp.debian.org/debian bullseye main contrib
deb http://ftp.debian.org/debian bullseye-updates main contrib
由proxmox.com提供的 PVE pve-no-subscription 存储库，
不推荐用于生产环境
deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription
安全更新
deb http://security.debian.org/debian-security bullseye-security main -
contrib

3.1.4 Proxmox VE 测试存储库
此存储库包含最新的软件包，主要供开发人员测试新功能。要配置它，请将以下行添加到 /etc/apt/sources.list：
sources.list entry for pvetest
deb http://download.proxmox.com/debian/pve bullseye pvetest
警告
pvetest 存储库（顾名思义）仅应用于测试新功能或修复错误。

3.1.5 Ceph Quincy 存储库
注意
Ceph Quincy（17.2）在 Proxmox VE 7.3 或之后的版本中被声明为稳定，使用 Ceph 17.2.1 版本。
此存储库包含主要的 Proxmox VE Ceph Quincy 软件包。它们适用于生产环境。如果在 Proxmox VE 上运行 Ceph 客户端或完整的 Ceph 集群，请使用此存储库。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-quincy bullseye main

3.1.6 Ceph Quincy 测试存储库
此 Ceph 存储库包含在 Ceph Quincy 软件包移至主存储库之前的软件包。它用于在 Proxmox VE 上测试新的 Ceph 版本。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-quincy bullseye test

3.1.7 Ceph Pacific 存储库
注意
Ceph Pacific（16.2）在 Proxmox VE 7.0 中被声明为稳定。
此存储库包含主要的 Proxmox VE Ceph Pacific 软件包。它们适用于生产环境。如果在 Proxmox VE 上运行 Ceph 客户端或完整的 Ceph 集群，请使用此存储库。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-pacific bullseye main
Proxmox VE 管理指南 28 / 534

3.1.8 Ceph Pacific 测试存储库
此 Ceph 存储库包含在 Ceph Pacific 软件包移至主存储库之前的软件包。它用于在 Proxmox VE 上测试新的 Ceph 版本。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-pacific bullseye test

3.1.9 Ceph Octopus 存储库
注意
Ceph Octopus（15.2）在 Proxmox VE 6.3 中被声明为稳定。在 6.x 版本的剩余生命周期内，
它将继续获得更新[?informaltable]，同时在 Proxmox VE 7.x 中，直到 Ceph Octopus 上游 EOL（大约 2022-07）也会继续获得更新。
此存储库包含主要的 Proxmox VE Ceph Octopus 软件包。它们适用于生产环境。如果在 Proxmox VE 上运行 Ceph 客户端或完整的 Ceph 集群，请使用此存储库。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-octopus bullseye main
请注意，在较旧的 Proxmox VE 6.x 上，您需要将上述存储库规范中的 bullseye 更改为 buster。

3.1.10 Ceph Octopus 测试存储库
此 Ceph 存储库包含在 Ceph 软件包移至主存储库之前的软件包。它用于在 Proxmox VE 上测试新的 Ceph 版本。
文件 /etc/apt/sources.list.d/ceph.list
deb http://download.proxmox.com/debian/ceph-octopus bullseye test

3.1.11 SecureApt
存储库中的发布文件使用 GnuPG 进行签名。APT 使用这些签名来验证所有软件包来自可信来源。
如果您从官方 ISO 映像安装 Proxmox VE，则已经安装了用于验证的密钥。
如果您在 Debian 上安装 Proxmox VE，请使用以下命令下载并安装密钥：
wget https://enterprise.proxmox.com/debian/proxmox-release-bullseye.gpg --O /etc/apt/trusted.gpg.d/proxmox-release-bullseye.gpg
之后使用 sha512sum CLI 工具验证校验和：
sha512sum /etc/apt/trusted.gpg.d/proxmox-release-bullseye.gpg7 -
fb03ec8a1675723d2853b84aa4fdb49a46a3bb72b9951361488bfd19b29aab0a789a4f8c7406e71a69aabbc727c936d3549731c4659ffa1a08f44db8fdcebfa /etc/apt/trusted.gpg.d/
proxmox-release-bullseye.gpg
或者使用 md5sum CLI 工具：
md5sum /etc/apt/trusted.gpg.d/proxmox-release-bullseye.gpg
bcc35c7173e0845c0d6ad6470b70f50e /etc/apt/trusted.gpg.d/proxmox-release- -
bullseye.gpg

3.2 系统软件更新
Proxmox 定期为所有存储库提供更新。要安装更新，请使用基于 Web 的 GUI 或以下 CLI 命令：
apt-get update
apt-get dist-upgrade
注意
APT 软件包管理系统非常灵活，提供了许多功能，请参阅 man apt-get 或 [Hertzog13] 以获取其他信息。
提示
定期更新对于获取最新的补丁和安全相关修复至关重要。Proxmox VE 社区论坛宣布主要系统升级。

3.3 网络配置
Proxmox VE 使用 Linux 网络堆栈。这为在 Proxmox VE 节点上设置网络提供了很多灵活性。
配置可以通过 GUI 完成，也可以通过手动编辑包含整个网络配置的文件 /etc/network/interfaces 完成。interfaces(5) 手册页包含完整的格式描述。所有 Proxmox VE 
工具都尽力保留直接用户修改，但使用 GUI 仍然更可取，因为它可以防止出错。
需要 vmbr 接口将客户机连接到底层物理网络。它们是一个 Linux 网桥，可以被认为是一个虚拟交换机，客户机和物理接口连接到该虚拟交换机。
本节提供了一些关于如何设置网络以适应不同用例的示例，如使用 bond 第 3.3.7 节的冗余，vlans 第 3.3.8 节或路由第 3.3.5 节和 NAT 第 3.3.6 节设置。
软件定义网络第 12 章是 Proxmox VE 集群中更复杂虚拟网络的一个选项。
Proxmox VE 管理指南 30 / 534
警告
不建议使用传统的 Debian 工具 ifup 和 ifdown（如果不确定），因为它们有一些陷阱，如在 ifdown vmbrX 时中断所有客户端流量，
但在稍后在同一桥上执行 ifup 时不重新连接这些客户端。

3.3.1 应用网络更改
Proxmox VE 不会直接将更改写入 /etc/network/interfaces。相反，我们将其写入一个名为 /etc/network/interfaces.new 
的临时文件，这样您就可以一次执行许多相关更改。这还允许在应用更改之前确保更改是正确的，因为错误的网络配置可能使节点无法访问。
使用 ifupdown2 实时重载网络
使用推荐的 ifupdown2 软件包（自 Proxmox VE 7.0 起为新安装的默认值），可以在不重新启动的情况下应用网络配置更改。
如果通过 GUI 更改网络配置，可以单击 Apply Configuration 
按钮。这将把更改从暂存的 interfaces.new 文件移动到 /etc/network/interfaces，并实时应用它们。
如果您直接对 /etc/network/interfaces 文件进行了手动更改，可以通过运行 ifreload -a 来应用它们。
注意
如果您在 Debian 上安装了 Proxmox VE，或者从旧版本的 Proxmox VE 升级到 Proxmox VE 7.0，请确保安装了 ifupdown2：apt install ifupdown2
重新启动节点以应用
另一种应用新网络配置的方法是重新启动节点。在这种情况下，systemd 服务 pvenetcommit 将在网络服务应用该配置之前激活暂存的 interfaces.new 
文件。这样，在节点重启时，新的网络配置将被应用。















