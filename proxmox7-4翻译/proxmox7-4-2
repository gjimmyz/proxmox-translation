proxmox7-4-2

第2章
安装 Proxmox VE

Proxmox VE基于Debian。这就是为什么Proxmox提供的安装磁盘映像（ISO文件）包含完整的Debian系统以及所有必要的Proxmox VE软件包。
提示
请参阅FAQ [?informaltable]中的支持表格，了解Proxmox VE版本与Debian版本之间的关系。
安装程序将指导您完成设置，允许您对本地磁盘进行分区，应用基本系统配置（例如时区、语言、网络）并安装所有必需的软件包。
这个过程不应该花费超过几分钟。对于新用户和现有用户，使用提供的ISO进行安装是推荐的方法。
另外，Proxmox VE可以安装在现有的Debian系统之上。这个选项仅推荐给高级用户，因为需要详细了解Proxmox VE。

2.1 系统要求
我们建议在生产环境中运行Proxmox VE时使用高质量的服务器硬件。要进一步减少主机故障的影响，您可以在具有高可用性（HA）虚拟机和容器的集群中运行Proxmox VE。
Proxmox VE可以使用本地存储（DAS）、SAN、NAS以及Ceph RBD等分布式存储。有关详细信息，请参阅存储章节第7章。

2.1.1 最低要求，用于评估
以下最低要求仅用于评估目的，不应在生产环境中使用。
• CPU：64位（英特尔EMT64或AMD64）
• 支持KVM全虚拟化的Intel VT/AMD-V兼容CPU/主板
• 内存：1 GB RAM，以及客户端需要的额外内存
• 硬盘
• 一个网卡（NIC）

2.1.2 推荐系统要求
• 带有 Intel VT/AMD-V CPU 标志的英特尔 EMT64 或 AMD64。
• 内存：最少 2 GB 用于操作系统和 Proxmox VE 服务，另外分配给客户机的内存。对于 Ceph 和 ZFS，需要额外的内存；大约每 TB 使用的存储需要 1GB 内存。
• 快速且冗余的存储，使用 SSD 可获得最佳效果。
• 操作系统存储：使用带有电池保护写缓存（“BBU”）的硬件 RAID 或非 RAID 的 ZFS（可选 SSD 用于 ZIL）。
• VM 存储：
    对于本地存储，请使用带有电池备份写缓存（BBU）的硬件 RAID 或用于 ZFS 和 Ceph 的非 RAID。ZFS 和 Ceph 均与硬件 RAID 控制器不兼容。
    可以使用共享和分布式存储。
    • 冗余（多）Gbit 网卡，根据首选存储技术和集群设置需要额外的网卡。
    • 对于 PCI(e) 透传，CPU 需要支持 VT-d/AMD-d 标志。

2.1.3 简单性能概述
要在已安装的 Proxmox VE 系统上获取 CPU 和硬盘性能的概述，请运行包含的 pveperf 工具。
注意
这仅仅是一个非常快速且通用的基准测试。建议进行更详细的测试，特别是关于您的系统的 I/O 性能。

2.1.4 访问 Web 界面所支持的 Web 浏览器
要访问基于 Web 的用户界面，我们建议使用以下浏览器之一：
• 当年发布的 Firefox 版本或最新的扩展支持版本
• 当年发布的 Chrome 版本
• Microsoft 当前支持的 Edge 版本
• 当年发布的 Safari 版本
当从移动设备访问 Proxmox VE 时，将显示一个轻量级的、基于触摸的界面。

2.2 准备安装介质
从以下地址下载安装程序 ISO 映像：https://www.proxmox.com/en/downloads/category/iso-images-pve
Proxmox VE 安装介质是一个混合 ISO 映像。它有两种工作方式：
• 准备刻录到 CD 或 DVD 的 ISO 映像文件。
• 准备复制到 USB 闪存驱动器（U 盘）的原始扇区（IMG）映像文件。
使用 USB 闪存驱动器安装 Proxmox VE 是推荐的方法，因为它是更快的选择。

2.2.1 将 USB 闪存驱动器准备为安装介质
闪存驱动器需要至少有 1 GB 的可用存储空间。
注意
不要使用 UNetbootin。它与 Proxmox VE 安装映像不兼容。
重要提示
确保 USB 闪存驱动器没有被挂载且不包含任何重要数据。

2.2.2 GNU/Linux 的说明
在类 Unix 操作系统上，使用 dd 命令将 ISO 映像复制到 USB 闪存驱动器。首先找到 USB 闪存驱动器的正确设备名称（参见下文）。然后运行 dd 命令。
dd bs=1M conv=fdatasync if=./proxmox-ve_*.iso of=/dev/XYZ
注意
确保用正确的设备名称替换 /dev/XYZ，并调整输入文件名（if）路径。
警告
非常小心，不要覆盖错误的磁盘！
找到正确的 USB 设备名称
有两种方法可以找到 USB 闪存驱动器的名称。第一种是比较插入闪存驱动器前后 dmesg 命令输出的最后几行。第二种方法是比较 lsblk 命令的输出。打开终端并运行：
lsblk
然后插入您的 USB 闪存驱动器并再次运行命令：
lsblk
将出现一个新设备。这就是您要使用的设备。为了确保安全，请检查报告的大小是否与您的 USB 闪存驱动器匹配。

2.2.3 macOS 的说明
打开终端（在 Spotlight 中查询 Terminal）。
使用 hdiutil 的 convert 选项将 .iso 文件转换为 .dmg 格式，例如：
hdiutil convert proxmox-ve_.iso -format UDRW -o proxmox-ve_.dmg
提示
macOS 倾向于在输出文件名中自动添加 .dmg。
要获取当前设备列表，请运行以下命令：
diskutil list
现在插入 USB 闪存驱动器，然后再次运行此命令以确定已分配给它的设备节点（例如，/dev/diskX）。
diskutil list
diskutil unmountDisk /dev/diskX
注意
用最后一个命令中的磁盘编号替换 X。
sudo dd if=proxmox-ve_*.dmg bs=1M of=/dev/rdiskX
注意
最后一个命令中的 rdiskX（而不是 diskX）是有意为之。它将提高写入速度。

2.2.4 Windows 的说明
使用 Etcher
Etcher 开箱即用。从 https://etcher.io 下载 Etcher。它将指导您选择 ISO 和 USB 驱动器。
使用 Rufus
Rufus 是一个更轻量级的替代方案，但您需要使用 DD 模式使其工作。从 https://rufus.ie/ 下载 Rufus。安装它或使用便携式版本。选择目标驱动器和 Proxmox VE ISO 文件。
重要提示
开始后，您必须在询问是否下载 GRUB 的其他版本的对话框中单击“否”。
在下一个对话框中选择 DD 模式。

2.3 使用 Proxmox VE 安装程序
安装器 ISO 映像包括以下内容：
• 完整操作系统（Debian Linux，64 位）
• Proxmox VE 安装程序，它使用 ext4、XFS、BTRFS（技术预览）或 ZFS 对本地磁盘进行分区并安装操作系统。
• 带有 KVM 和 LXC 支持的 Proxmox VE Linux 内核
• 用于管理虚拟机、容器、主机系统、集群和所有必要资源的完整工具集
• 基于 Web 的管理界面
注意
在安装过程中，将删除在安装选定驱动器上的所有现有数据。安装程序不会为其他操作系统添加启动菜单条目。
请插入准备好的安装介质第 2.2 节（例如，USB 闪存驱动器或 CD-ROM），并从其启动。
提示
确保在服务器固件设置中启用了从安装介质（例如，USB）启动，并禁用了安全启动。
在选择正确的条目（例如，从 USB 启动）后，将显示 Proxmox VE 菜单，可以选择以下选项之一：
安装 Proxmox VE
开始正常安装。
提示
仅使用键盘即可使用安装向导。通过按下 ALT 键与相应按钮的下划线字符组合，可以单击按钮。例如，按 ALT + N 来按下“下一步”按钮。
高级选项：安装 Proxmox VE（调试模式）
以调试模式启动安装。在几个安装步骤中将打开一个控制台。如果出现问题，这有助于调试情况。要退出调试控制台，请按 
CTRL-D。此选项可用于使用所有基本工具启动实时系统。例如，您可以使用它来修复现有 Proxmox VE 设置的降级 ZFS rpool 第 3.8 节或修复引导加载程序第 3.12 节。
高级选项：救援启动
使用此选项，您可以启动现有安装。它会搜索所有已连接的硬盘。如果找到现有安装，它将直接使用 ISO 中的 Linux 内核引导到该磁盘。如果引导块（grub）出现问题或 BIOS 
无法从磁盘读取引导块，这会很有用。
高级选项：测试内存
运行 memtest86+。这对于检查内存是否正常工作且无错误非常有用。
在选择“安装 Proxmox VE”并接受 EULA 之后，将出现选择目标硬盘的提示。单击“选项”按钮可打开选择目标文件系统的对话框。
默认文件系统为 ext4。当选择 ext4 或 xfs 时，将使用逻辑卷管理器 (LVM)。还可以设置其他选项来限制 LVM 空间（见下文）。
Proxmox VE 可以安装在 ZFS 上。由于 ZFS 提供了多种软件 RAID 级别，这是没有硬件 RAID 控制器的系统的一个选项。
必须在“选项”对话框中选择目标磁盘。在“高级选项”下可以更改更多 ZFS 特定的设置（见下文）。
警告
ZFS 在任何硬件 RAID 之上都不受支持，并可能导致数据丢失。
下一页要求输入基本配置选项，如位置、时区和键盘布局。位置用于选择附近的下载服务器以加快更新速度。安装程序通常会自动检测这些设置。
仅在自动检测失败或需要使用不同键盘布局的罕见情况下才需要更改它们。
接下来需要指定超级用户（root）的密码和电子邮件地址。密码必须至少包含5个字符。强烈建议使用更强的密码。一些指南包括：
• 使用至少12到14个字符的密码长度。
• 包括小写和大写字母字符、数字和符号。
• 避免字符重复、键盘模式、常见字典单词、字母或数字序列、用户名、亲戚或宠物名字、浪漫关联（现在或过去的）和传记信息（例如身份证号码、祖先姓名或日期）。
电子邮件地址用于向系统管理员发送通知。例如：
• 关于可用软件包更新的信息。
• 定期 CRON 作业的错误消息。
最后一步是网络配置。请注意，在安装过程中，您可以使用 IPv4 或 IPv6 地址，但不能同时使用两者。要配置双协议栈节点，请在安装后添加其他 IP 地址。
下一步显示以前选择的选项摘要。重新检查每个设置，并在需要更改设置时使用“上一步”按钮。要接受，请按“安装”。安装将开始格式化磁盘并将软件包复制到目标。
请等待此步骤完成，然后取出安装介质并重新启动系统。
如果安装失败，请在第二个 TTY（'CTRL + ALT + F2'）上检查特定错误，并确保系统满足最低要求第 2.1.1 节。
如果安装仍无法正常工作，请查看如何获取帮助章节第 1.10 节
安装完成后，可以通过 Proxmox 网页界面进行进一步配置。在浏览器中指向安装过程中给出的 IP 地址（https://youripaddress:8006）。
注意
默认登录名为 "root"（领域 PAM），在安装过程中定义了 root 密码。

2.3.1 高级 LVM 配置选项
安装程序会创建一个名为 pve 的卷组（VG）以及名为 root、data 和 swap 的额外逻辑卷（LV）。要控制这些卷的大小，请使用以下选项：
hdsize
定义要使用的总硬盘大小。这样，您可以为进一步分区（例如在同一硬盘上用于 LVM 存储的额外 PV 和 VG）预留硬盘上的空闲空间。
swapsize
定义 swap 卷的大小。默认值为已安装内存的大小，最小 4 GB，最大 8 GB。得出的值不能大于 hdsize/8。
注意
如果设置为 0，则不会创建 swap 卷。
maxroot
定义存储操作系统的根卷的最大大小。根卷大小的最大限制为 hdsize/4。
maxvz
定义数据卷的最大大小。数据卷的实际大小为：
datasize = hdsize - rootsize - swapsize - minfree
其中，datasize 不能大于 maxvz。
注意
对于 LVM thin，只有当 datasize 大于 4GB 时才会创建数据池。
注意
如果设置为 0，则不会创建数据卷，存储配置将相应地进行调整。
minfree
定义 LVM 卷组 pve 中剩余的空闲空间量。如果有超过 128GB 的存储可用，缺省值为 16GB，否则将使用 hdsize/8。
注意
LVM 需要 VG 中的空闲空间来创建快照（对于 lvmthin 快照不需要）。

2.3.2 高级 ZFS 配置选项
安装程序创建 ZFS 池 rpool。不会创建交换空间，但您可以在安装磁盘上为交换空间预留一些未分区空间。安装后，您还可以创建一个交换 zvol，尽管这可能导致问题（请参阅 ZFS 交换备注）。
ashift
定义创建的池的 ashift 值。ashift 至少需要设置为底层磁盘的扇区大小（2 的 ashift 次幂是扇区大小），或者可能放入池中的任何磁盘（例如，替换有缺陷的磁盘）。
compress
定义是否为 rpool 启用压缩。
checksum
定义应为 rpool 使用哪个校验和算法。
copies
定义 rpool 的副本参数。检查 zfs(8) 手册页以了解语义，以及为什么这不会替换磁盘级别的冗余。
hdsize
定义要使用的总硬盘大小。这对于在硬盘上保留空闲空间以进行进一步分区（例如创建交换分区）非常有用。
hdsize 仅适用于可引导磁盘，即仅适用于 RAID0、RAID1 或 RAID10 的第一个磁盘或镜像，以及 RAID-Z[123] 中的所有磁盘。

2.3.3 ZFS 性能提示
ZFS 在大量内存下工作效果最佳。如果您打算使用 ZFS，请确保为其提供足够的 RAM。一个好的计算方法是 4GB 加上每 TB RAW 磁盘空间的 1GB RAM。
ZFS 可以使用专用驱动器作为写入缓存，称为 ZFS Intent Log（ZIL）。请为其使用快速驱动器（SSD）。可以在安装后使用以下命令添加：
zpool add <pool-name> log </dev/path_to_fast_ssd>

2.4 在 Debian 上安装 Proxmox VE
Proxmox VE 作为一组 Debian 软件包发布，可以安装在标准 Debian 安装的基础上。配置了存储库 Section 3.1 之后，您需要运行以下命令：
apt-get update
apt-get install proxmox-ve
在现有的 Debian 安装上安装看起来很简单，但前提是基本系统已正确安装，您知道如何配置和使用本地存储。您还需要手动配置网络。
总的来说，这并非琐碎之事，尤其是在使用 LVM 或 ZFS 的情况下。
详细的逐步操作指南可以在 wiki 上找到。